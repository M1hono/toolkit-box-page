name: r2 Sync Workflow

on:
    workflow_dispatch:
        inputs:
            force_reset:
                description: "Force reset upload logs (re-upload all files)"
                required: false
                default: false
                type: boolean
            clean_failures:
                description: "Clean failure logs"
                required: false
                default: false
                type: boolean
    workflow_run:
        workflows: ["Main Data Pipeline"]
        types:
            - completed

jobs:
    sync-to-r2:
        runs-on: ubuntu-latest
        timeout-minutes: 120
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"

            - name: Install dependencies
              working-directory: docs
              run: yarn install --frozen-lockfile

            - name: Clean WebP files from arknights/characters/
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Cleaning WebP files from arknights/characters/..."
                  node scripts/one-time-cleanup-webp.cjs
                  echo "WebP cleanup complete"

            - name: Clean up logs if requested
              working-directory: docs
              run: |
                  if [ "${{ inputs.force_reset }}" = "true" ]; then
                    echo "Force reset: Removing upload logs"
                    rm -f .vitepress/logs/uploaded.json
                    rm -f .vitepress/logs/*-uploaded.json
                  fi

                  if [ "${{ inputs.clean_failures }}" = "true" ]; then
                    echo "Cleaning failure logs"
                    rm -f .vitepress/logs/r2-sync-failures.json
                    rm -f .vitepress/logs/*-failures.json
                  fi

            - name: Sync JSON data to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing JSON data..."
                  yarn r2:data
                  echo "JSON data complete"

            - name: Sync character variants to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing character variant images (PNG)..."
                  yarn r2:characters
                  echo "Character variants complete"

            - name: Sync variant avatars to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing variant avatars (WebP)..."
                  yarn r2:variant-avatars
                  echo "Variant avatars complete"

            - name: Sync story avatars to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing story avatars (operator icons)..."
                  yarn r2:story-avatars
                  echo "Story avatars complete"

            - name: Sync story icons and banners to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing story icons and banners..."
                  yarn r2:story-icons
                  echo "Story icons and banners complete"

            - name: Sync FGO assets to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing FGO assets (fonts + UI)..."
                  yarn r2:fgo-assets
                  echo "FGO assets sync complete"

            - name: Upload sync logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: r2-sync-logs
                  path: docs/.vitepress/logs/
                  retention-days: 30

            - name: Commit R2 sync logs
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  # Check if any log files exist
                  if [ -d "docs/.vitepress/logs" ] && [ "$(ls -A docs/.vitepress/logs/)" ]; then
                    echo "Found log files, adding to git..."
                    git add docs/.vitepress/logs/
                    
                    if ! git diff --cached --quiet; then
                      echo "Changes detected, committing..."
                      git commit -m "Update R2 sync logs [$(date '+%Y-%m-%d %H:%M:%S')]"
                      
                      echo "Pushing R2 sync logs..."
                      for i in {1..3}; do
                        if git push; then
                          echo "R2 sync logs pushed successfully"
                          break
                        else
                          echo "Push failed, retrying ($i/3)"
                          git pull --rebase origin main
                          if [ $? -eq 0 ]; then
                            echo "Successfully pulled remote changes"
                          else
                            echo "Pull failed, skipping push"
                            break
                          fi
                        fi
                      done
                    else
                      echo "No R2 sync log changes to commit"
                    fi
                  else
                    echo "No R2 sync log files found"
                  fi

            - name: Show sync summary
              if: always()
              working-directory: docs
              run: |
                  echo "üìä Sync Summary:"
                  
                  if [ -d ".vitepress/logs" ]; then
                    echo "üìÅ Log files created:"
                    ls -la .vitepress/logs/
                    echo ""
                    
                    # Count total log files
                    log_count=$(find .vitepress/logs/ -name "*.json" | wc -l)
                    echo "üìÑ Total log files: $log_count"
                    
                    # Show file sizes
                    for file in .vitepress/logs/*.json; do
                      if [ -f "$file" ]; then
                        size=$(du -h "$file" | cut -f1)
                        echo "   $(basename "$file"): $size"
                      fi
                    done
                    
                    echo ""
                    echo "‚úÖ All tracker logs will be committed to repository"
                  else
                    echo "‚ùå No logs directory found"
                  fi

                  echo "üéâ R2 sync workflow completed"