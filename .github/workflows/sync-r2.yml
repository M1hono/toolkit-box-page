name: Sync Images to R2

on:
    workflow_dispatch:
        inputs:
            force_reset:
                description: "Force reset upload logs (re-upload all files)"
                required: false
                default: false
                type: boolean
            clean_failures:
                description: "Clean failure logs"
                required: false
                default: false
                type: boolean
    workflow_run:
        workflows: ["Main Data Pipeline"]
        types:
            - completed

jobs:
    sync-to-r2:
        runs-on: ubuntu-latest
        timeout-minutes: 120
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"

            - name: Install dependencies
              working-directory: docs
              run: yarn install --frozen-lockfile

            - name: Clean up R2 wrong paths if requested
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
                  CONFIRM_DELETE: "true"
              run: |
                  echo "Cleaning up files in wrong R2 paths..."
                  yarn r2:cleanup
                  echo "Cleanup complete"

            - name: Clean up logs if requested
              working-directory: docs
              run: |
                  if [ "${{ inputs.force_reset }}" = "true" ]; then
                    echo "Force reset: Removing upload logs"
                    rm -f .vitepress/logs/uploaded.json
                  fi

                  if [ "${{ inputs.clean_failures }}" = "true" ]; then
                    echo "Cleaning failure logs"
                    rm -f .vitepress/logs/r2-sync-failures.json
                  fi

            - name: Sync JSON data to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing JSON data..."
                  yarn r2:data
                  echo "JSON data complete"

            - name: Sync character variants to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing character variant images (PNG)..."
                  yarn r2:characters
                  echo "Character variants complete"

            - name: Sync variant avatars to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing variant avatars (WebP)..."
                  yarn r2:variant-avatars
                  echo "Variant avatars complete"

            - name: Sync story avatars to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing story avatars (operator icons)..."
                  yarn r2:story-avatars
                  echo "Story avatars complete"

            - name: Sync story icons and banners to R2
              working-directory: docs
              env:
                  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
              run: |
                  echo "Syncing story icons and banners..."
                  yarn r2:story-icons
                  echo "Story icons and banners complete"

            - name: Upload sync logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: r2-sync-logs
                  path: docs/.vitepress/logs/
                  retention-days: 30

            - name: Commit R2 sync logs
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  if [ -f "docs/.vitepress/logs/uploaded.json" ] || [ -f "docs/.vitepress/logs/r2-sync-failures.json" ]; then
                    git add docs/.vitepress/logs/
                    
                    if ! git diff --cached --quiet; then
                      git commit -m "Update R2 sync logs (manual trigger) $(date '+%Y-%m-%d %H:%M:%S')"
                      
                      echo "Pushing R2 sync logs..."
                      for i in {1..3}; do
                        if git push; then
                          echo "R2 sync logs pushed successfully"
                          break
                        else
                          echo "Push failed, retrying ($i/3)"
                          git pull --rebase origin main
                          if [ $? -eq 0 ]; then
                            echo "Successfully pulled remote changes"
                          else
                            echo "Pull failed, skipping push"
                            break
                          fi
                        fi
                      done
                    else
                      echo "No R2 sync log changes"
                    fi
                  else
                    echo "No R2 sync log files found"
                  fi

            - name: Show sync summary
              if: always()
              working-directory: docs
              run: |
                  echo "Sync Summary:"
                  if [ -f ".vitepress/logs/uploaded.json" ]; then
                    echo "Upload log file size: $(du -h .vitepress/logs/uploaded.json | cut -f1)"
                    if command -v jq &> /dev/null; then
                      echo "Uploaded files count: $(jq 'length' .vitepress/logs/uploaded.json)"
                    else
                      echo "Upload log exists (jq not available for count)"
                    fi
                  else
                    echo "No upload log file found"
                  fi

                  if [ -f ".vitepress/logs/r2-sync-failures.json" ]; then
                    echo "Failure log exists, check artifacts"
                    if command -v jq &> /dev/null; then
                      echo "Failure stats: $(jq '.downloadFailures | length' .vitepress/logs/r2-sync-failures.json) download failures, $(jq '.uploadFailures | length' .vitepress/logs/r2-sync-failures.json) upload failures"
                    else
                      echo "Failure log exists (jq not available for details)"
                    fi
                  else
                    echo "No failure logs"
                  fi

                  echo "R2 sync workflow completed"