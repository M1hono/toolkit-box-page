name: Sync Arknights Story Data

on:
    schedule:
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            clean_first:
                description: "Clean existing data before sync"
                required: false
                default: true
                type: boolean
            dry_run:
                description: "Preview mode (no actual download)"
                required: false
                default: false
                type: boolean

permissions:
    contents: write

concurrency:
    group: "story-data-sync"
    cancel-in-progress: true

jobs:
    sync-story-data:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        outputs:
            data-updated: ${{ steps.check-changes.outputs.changed }}
            file-count: ${{ steps.sync-result.outputs.file-count }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "yarn"

            - name: Install dependencies
              working-directory: docs
              run: yarn install --frozen-lockfile

            - name: Setup Git
              run: |
                  git config --global user.email "action@github.com"
                  git config --global user.name "GitHub Action"
                  echo "Git configuration complete"

            - name: Sync Story Data
              id: sync-result
              working-directory: docs
              run: |
                  echo "Starting Arknights story data synchronization..."
                  echo "Configuration:"
                  echo "  - Clean existing data: ${{ inputs.clean_first || 'true' }}"
                  echo "  - Preview mode: ${{ inputs.dry_run || 'false' }}"

                  ARGS=""

                  if [ "${{ inputs.dry_run }}" = "true" ]; then
                    ARGS="$ARGS --dry-run"
                    echo "Using preview mode"
                  fi

                  if [ "${{ inputs.clean_first }}" = "false" ]; then
                    ARGS="$ARGS --no-clean"
                    echo "Preserving existing data"
                  fi

                  echo "Executing: node scripts/arknights/syncStoryData.cjs $ARGS"

                  if node scripts/arknights/syncStoryData.cjs $ARGS > sync_output.log 2>&1; then
                    echo "Story data sync successful"
                    
                    FILE_COUNT=$(grep -o "synced: [0-9]* files" sync_output.log | grep -o "[0-9]*" | head -1 || echo "unknown")
                    echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
                    
                    echo "Sync details:"
                    cat sync_output.log
                  else
                    echo "Story data sync failed"
                    echo "Error details:"
                    cat sync_output.log
                    exit 1
                  fi

            - name: Check for changes
              id: check-changes
              if: inputs.dry_run != 'true'
              run: |
                  if git diff --quiet HEAD -- docs/src/public/data/; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "Story data unchanged"
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Story data updated"
                    
                    echo "Change statistics:"
                    git diff --stat HEAD -- docs/src/public/data/
                  fi

            - name: Upload sync report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: story-sync-report-${{ github.run_number }}
                  path: docs/sync_output.log
                  retention-days: 7

            - name: Commit story data changes
              if: steps.check-changes.outputs.changed == 'true' && inputs.dry_run != 'true'
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add docs/src/public/data/

                  COMMIT_MSG="Update Arknights story data $(date '+%Y-%m-%d %H:%M:%S')"

                  if [ "${{ steps.sync-result.outputs.file-count }}" != "unknown" ]; then
                    COMMIT_MSG="$COMMIT_MSG"$'\n'"File count: ${{ steps.sync-result.outputs.file-count }}"
                  fi

                  ADDED=$(git diff --cached --numstat | awk '{sum+=$1} END {print sum+0}')
                  DELETED=$(git diff --cached --numstat | awk '{sum+=$2} END {print sum+0}')
                  COMMIT_MSG="$COMMIT_MSG"$'\n'"Changes: +$ADDED/-$DELETED lines"

                  git commit -m "$COMMIT_MSG"
                  
                  echo "Pushing story data updates..."
                  for i in {1..3}; do
                    if git push; then
                      echo "Push successful"
                      break
                    else
                      echo "Push failed, retrying ($i/3)"
                      git pull --rebase origin main
                      if [ $? -eq 0 ]; then
                        echo "Successfully pulled remote changes"
                      else
                        echo "Pull failed, skipping push"
                        exit 1
                      fi
                    fi
                  done

                  echo "Story data changes committed to repository"

            - name: Summary
              if: always()
              run: |
                  echo "Story Data Sync Summary"
                  echo "======================"
                  echo "File count: ${{ steps.sync-result.outputs.file-count || 'unknown' }}"
                  echo "Data updated: ${{ steps.check-changes.outputs.changed || 'skipped (dry-run)' }}"
                  echo "Run time: $(date '+%Y-%m-%d %H:%M:%S')"

                  if [ "${{ inputs.dry_run }}" = "true" ]; then
                    echo "Preview mode: No actual data modification"
                  elif [ "${{ steps.check-changes.outputs.changed }}" = "true" ]; then
                    echo "Story data successfully synced and committed"
                  else
                    echo "Story data unchanged"
                  fi
