name: Sync Arknights Story Data

on:
    schedule:
        # æ¯å¤©UTC 2ç‚¹ (åŒ—äº¬æ—¶é—´10ç‚¹) è¿è¡Œï¼Œé¿å¼€ä¸»ä»»åŠ¡é«˜å³°æœŸ
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            sync_method:
                description: "é€‰æ‹©åŒæ­¥æ–¹æ³•"
                required: true
                default: "auto"
                type: choice
                options:
                    - "auto"
                    - "git"
                    - "api"
            clean_first:
                description: "æ¸…ç†ç°æœ‰æ•°æ®"
                required: false
                default: true
                type: boolean
            dry_run:
                description: "é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…ä¸‹è½½ï¼‰"
                required: false
                default: false
                type: boolean

permissions:
    contents: write

concurrency:
    group: "story-data-sync"
    cancel-in-progress: true

jobs:
    sync-story-data:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        outputs:
            data-updated: ${{ steps.check-changes.outputs.changed }}
            sync-method: ${{ steps.sync-result.outputs.method }}
            file-count: ${{ steps.sync-result.outputs.file-count }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "yarn"

            - name: Install dependencies
              working-directory: docs
              run: yarn install --frozen-lockfile

            - name: Setup Git for sparse-checkout
              run: |
                  git config --global user.email "action@github.com"
                  git config --global user.name "GitHub Action"
                  echo "ğŸ“‹ Git é…ç½®å®Œæˆï¼Œæ”¯æŒ sparse-checkout"

            - name: Sync Story Data
              id: sync-result
              working-directory: docs
              run: |
                  echo "ğŸ“š å¼€å§‹åŒæ­¥æ˜æ—¥æ–¹èˆŸæ•…äº‹æ•°æ®..."
                  echo "âš™ï¸ é…ç½®å‚æ•°:"
                  echo "  - åŒæ­¥æ–¹æ³•: ${{ inputs.sync_method || 'auto' }}"
                  echo "  - æ¸…ç†ç°æœ‰æ•°æ®: ${{ inputs.clean_first || 'true' }}"
                  echo "  - é¢„è§ˆæ¨¡å¼: ${{ inputs.dry_run || 'false' }}"

                  # æ„å»ºå‘½ä»¤å‚æ•°
                  ARGS=""

                  if [ "${{ inputs.dry_run }}" = "true" ]; then
                    ARGS="$ARGS --dry-run"
                    echo "ğŸ§ª ä½¿ç”¨é¢„è§ˆæ¨¡å¼"
                  fi

                  if [ "${{ inputs.clean_first }}" = "false" ]; then
                    ARGS="$ARGS --no-clean"
                    echo "ğŸ“ ä¿ç•™ç°æœ‰æ•°æ®"
                  fi

                  # è¿è¡ŒåŒæ­¥è„šæœ¬
                  echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: node scripts/arknights/syncStoryData.js $ARGS"

                  # æ•è·åŒæ­¥ç»“æœ
                  if node scripts/arknights/syncStoryData.js $ARGS > sync_output.log 2>&1; then
                    echo "âœ… æ•…äº‹æ•°æ®åŒæ­¥æˆåŠŸ"
                    
                    # æå–åŒæ­¥ä¿¡æ¯ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                    if grep -q "GitåŒæ­¥å®Œæˆ" sync_output.log; then
                      echo "method=git-sparse-checkout" >> $GITHUB_OUTPUT
                      FILE_COUNT=$(grep -o "å…±åŒæ­¥ [0-9]* ä¸ªæ–‡ä»¶" sync_output.log | grep -o "[0-9]*" || echo "unknown")
                      echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
                    elif grep -q "APIåŒæ­¥å®Œæˆ" sync_output.log; then
                      echo "method=github-api" >> $GITHUB_OUTPUT
                      FILE_COUNT=$(grep -o "æˆåŠŸ: [0-9]*" sync_output.log | grep -o "[0-9]*" || echo "unknown")
                      echo "file-count=$FILE_COUNT" >> $GITHUB_OUTPUT
                    else
                      echo "method=unknown" >> $GITHUB_OUTPUT
                      echo "file-count=unknown" >> $GITHUB_OUTPUT
                    fi
                    
                    # æ˜¾ç¤ºåŒæ­¥è¾“å‡º
                    echo "ğŸ“‹ åŒæ­¥è¯¦æƒ…:"
                    cat sync_output.log
                  else
                    echo "âŒ æ•…äº‹æ•°æ®åŒæ­¥å¤±è´¥"
                    echo "ğŸ“‹ é”™è¯¯è¯¦æƒ…:"
                    cat sync_output.log
                    exit 1
                  fi

            - name: Check for changes
              id: check-changes
              if: inputs.dry_run != 'true'
              run: |
                  if git diff --quiet HEAD -- docs/src/public/data/arknights/story/; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "ğŸ“Š æ•…äº‹æ•°æ®æ²¡æœ‰å˜åŒ–"
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "ğŸ“Š æ•…äº‹æ•°æ®å·²æ›´æ–°"
                    
                    # æ˜¾ç¤ºå˜åŒ–ç»Ÿè®¡
                    echo "ğŸ“ˆ å˜åŒ–ç»Ÿè®¡:"
                    git diff --stat HEAD -- docs/src/public/data/arknights/story/
                  fi

            - name: Upload sync report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: story-sync-report-${{ github.run_number }}
                  path: |
                      docs/logs/story-sync-report.json
                      docs/sync_output.log
                  retention-days: 7

            - name: Commit story data changes
              if: steps.check-changes.outputs.changed == 'true' && inputs.dry_run != 'true'
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add docs/src/public/data/arknights/story/

                  # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
                  COMMIT_MSG="ğŸ“š æ›´æ–°æ˜æ—¥æ–¹èˆŸæ•…äº‹æ•°æ® $(date '+%Y-%m-%d %H:%M:%S')"

                  # æ·»åŠ åŒæ­¥æ–¹æ³•ä¿¡æ¯
                  if [ "${{ steps.sync-result.outputs.method }}" != "unknown" ]; then
                    COMMIT_MSG="$COMMIT_MSG"$'\n\n'"ğŸ”§ åŒæ­¥æ–¹æ³•: ${{ steps.sync-result.outputs.method }}"
                  fi

                  # æ·»åŠ æ–‡ä»¶æ•°é‡ä¿¡æ¯
                  if [ "${{ steps.sync-result.outputs.file-count }}" != "unknown" ]; then
                    COMMIT_MSG="$COMMIT_MSG"$'\n'"ğŸ“Š æ–‡ä»¶æ•°é‡: ${{ steps.sync-result.outputs.file-count }}"
                  fi

                  # æ·»åŠ å˜åŒ–ç»Ÿè®¡
                  ADDED=$(git diff --cached --numstat | awk '{sum+=$1} END {print sum+0}')
                  DELETED=$(git diff --cached --numstat | awk '{sum+=$2} END {print sum+0}')
                  COMMIT_MSG="$COMMIT_MSG"$'\n'"ğŸ“ˆ å˜åŒ–: +$ADDED/-$DELETED è¡Œ"

                   git commit -m "$COMMIT_MSG"
                   
                   # å¤„ç†å¯èƒ½çš„æ¨é€å†²çª
                   echo "ğŸ”„ æ¨é€æ•…äº‹æ•°æ®æ›´æ–°..."
                   for i in {1..3}; do
                     if git push; then
                       echo "âœ… æ¨é€æˆåŠŸ"
                       break
                     else
                       echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–å¹¶é‡æ–°æ¨é€ (å°è¯• $i/3)"
                       git pull --rebase origin main
                       if [ $? -eq 0 ]; then
                         echo "ğŸ“¥ æˆåŠŸæ‹‰å–è¿œç¨‹æ›´æ”¹"
                       else
                         echo "âŒ æ‹‰å–å¤±è´¥ï¼Œè·³è¿‡æ­¤æ¬¡æ¨é€"
                         exit 1
                       fi
                     fi
                   done
 
                   echo "âœ… æ•…äº‹æ•°æ®å˜åŒ–å·²æäº¤åˆ°ä»“åº“"

            - name: Summary
              if: always()
              run: |
                  echo "ğŸ“‹ æ•…äº‹æ•°æ®åŒæ­¥æ‘˜è¦"
                  echo "===================="
                  echo "ğŸ”§ åŒæ­¥æ–¹æ³•: ${{ steps.sync-result.outputs.method || 'unknown' }}"
                  echo "ğŸ“Š æ–‡ä»¶æ•°é‡: ${{ steps.sync-result.outputs.file-count || 'unknown' }}"
                  echo "ğŸ“ˆ æ•°æ®æ›´æ–°: ${{ steps.check-changes.outputs.changed || 'skipped (dry-run)' }}"
                  echo "â±ï¸ è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

                  if [ "${{ inputs.dry_run }}" = "true" ]; then
                    echo "ğŸ§ª é¢„è§ˆæ¨¡å¼ï¼šæœªå®é™…ä¿®æ”¹æ•°æ®"
                  elif [ "${{ steps.check-changes.outputs.changed }}" = "true" ]; then
                    echo "âœ… æ•…äº‹æ•°æ®å·²æˆåŠŸåŒæ­¥å¹¶æäº¤"
                  else
                    echo "â„¹ï¸ æ•…äº‹æ•°æ®æ— å˜åŒ–"
                  fi
